default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    api_key = app_store_connect_api_key(
      key_id: "7VR69CHB86",
      issuer_id: "97c1df4a-faa8-490c-8a15-1173f54d7362",
      key_filepath: "/Users/srinathprasannancs/.appstoreconnect/private_keys/AuthKey_7VR69CHB86.p8"
    )

    # Build number managed in project.yml â€” no auto-increment

    # Get certificates and provisioning profiles
    get_certificates(
      api_key: api_key,
      platform: "ios"
    )

    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.contextkey.app",
      platform: "ios"
    )

    # Build the app
    build_app(
      project: "ContextKeyV2.xcodeproj",
      scheme: "ContextKeyV2",
      export_method: "app-store",
      output_directory: "build",
      output_name: "ContextKeyV2.ipa",
      clean: true
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end
end
